Date: 2010-02-28 15:36:29
Author: evilsocket
Categories: PHP, Programmazione, Sorgenti
Tags: cache, caching, fast, mysql, performance, PHP, query, serialization, speed, tuning
Title: Usare la serializzazione in PHP per il caching delle query SQL

Da quando ho preso un server dedicato (e ne ho cambiati parecchi XD), ho iniziato a studiare per bene il tuning dei vari demoni che utilizzo per ottenere il massimo delle prestazioni con il minimo consumo di risorse .

Inutile dire che mi si è aperto un mondo, ho decisamente rivalutato il lavoro dei sistemisti (di quelli seri almeno) che spesso può risultare ben più ostico di quello di uno sviluppatore, dovendosi barcamenare tra documentazioni fatte male, file di configurazione gigantenormi, miriadi di parametri per ogni demone ecc ecc ecc.

Una delle funzionalità che non conoscevo e che ho scoperto durante questo periodo di studio, è il caching delle query di MySQL .

In parole povere il server MySQL, dopo aver abilitato tale configurazione, inizierà ad inserire in un suo storage in memoria (almeno credo sia in memoria) i risultati delle query che secondo lui sono cachabili in modo tale da non dover ogni volta rieseguirle, ma dovendo semplicemente prelevare i risultati da quel suo storage aumentando di parecchio le prestazioni generali di una web application che faccia un uso massiccio del database (perchè esistono ora come ora web app degne di chiamarsi così che non usano un db? :P).

E' ovvio che questa funzionalità può essere abilitata se e solo se si ha la possibilità di mettere mano sui file di configurazione del proprio server, cosa che naturalmente è impensabile per coloro che hanno un normale hosting condiviso che a malapena sono liberi di smanettare nella loro directory web.

Per questo motivo ho scritto un piccolo set di funzioni PHP che fanno questa cosa al posto del demone MySQL dando a chiunque la possibilità di aumentare notevolmente le prestazioni del proprio sito PHP/MySQL based ^^

<break>In pratica, chi volesse sviluppare un applicazione web, dovrà utilizzare piùttosto delle funzioni native per mysql, le funzioni che mette a disposizione questa piccola libreria.

A sua volta la libreria si occuperà di eseguire le query, determinare se una determinata query è inseribile in cache o meno, ripulire la cache in caso di aggiornamento dei dati, ecc ecc ecc il tutto sfruttando la <a href="http://php.net/manual/en/function.serialize.php" target="_blank">serializzazione degli oggetti in php</a> .

L'esempio più semplice di utilizzo della libreria potrebbe essere :

<div class="codecolorer-container php default" style="overflow:auto;white-space:nowrap;width:100%;height:100%;"><div class="php codecolorer"><span class="kw2">&lt;?php</span><br />
<span class="kw1">include_once</span><span class="br0">&#40;</span> <span class="st0">&quot;dbcache.php&quot;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
<br />
dbc_init<span class="br0">&#40;</span> <span class="co1">// hostname, utente, password e nome del database al quale connettersi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;localhost&quot;</span><span class="sy0">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;utente&quot;</span><span class="sy0">,</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;password&quot;</span><span class="sy0">,</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;nome del db&quot;</span><span class="sy0">,</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// directory in cui salvare i file della cache (deve esistere ed essere scrivibile)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;/path/in/cui/salvare/la/cache&quot;</span><span class="sy0">,</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// timeout espresso in secondi di un elemento nella cache, dopo il quale verrà eliminato</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="nu0">1800</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<span class="co1">// esegue la query</span><br />
<span class="re0">$obj</span> <span class="sy0">=</span> dbc_query<span class="br0">&#40;</span> <span class="st0">&quot;SELECT * FROM notizie&quot;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
<br />
<span class="co1">// fetcha un array associativo per ogni recordset della query</span><br />
<span class="kw1">while</span><span class="br0">&#40;</span> <span class="re0">$row</span> <span class="sy0">=</span> dbc_fetch_assoc<span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">echo</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'titolo'</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st0">&quot;&lt;br/&gt;&quot;</span><span class="sy0">;</span><br />
<span class="br0">&#125;</span><br />
<br />
<span class="sy1">?&gt;</span></div></div>

La prima volta che verrà eseguita, la query sarà inviata al database MySQL vero e proprio ed i risultati messi in cache, dalla seconda in poi invece i risultati verranno prelevati direttamente dallo storage su filesystem aumentando i tempi di risposta ed elaborazione e risparmiando le risorse che avrebbe richiesto il database per eseguire la query.

La cache (che è unica per ogni query, ovvero 10 query in cache equivalgono a 10 file diversi) viene eliminata in due casi :
<ol>
	<li>Se il tempo di creazione di un file nella cache supera il timeout impostato durante l'inizializzazione (quindi se è scaduto.</li>
	<li>Se viene eseguita una query non cachabile, come una INSERT o una UPDATE poichè potenzialmente modificano i dati sul database, rendendo necessario un aggiornamento anche nella cache.</li>
</ol>
Bon, detto questo, spero che la libreria possa essere utile a qualcuno, vi lascio con il codice ^^

<div class="codecolorer-container php default" style="overflow:auto;white-space:nowrap;width:100%;height:100%;"><div class="php codecolorer"><span class="kw2">&lt;?php</span><br />
<span class="coMULTI">/*<br />
&nbsp;* This file is part of DBCACHE.<br />
&nbsp;*<br />
&nbsp;* Copyleft of Simone Margaritelli aka evilsocket &lt;evilsocket@gmail.com&gt;<br />
&nbsp;*<br />
&nbsp;* DBCACHE is free software: you can redistribute it and/or modify<br />
&nbsp;* it under the terms of the GNU General Public License as published by<br />
&nbsp;* the Free Software Foundation, either version 3 of the License, or<br />
&nbsp;* (at your option) any later version.<br />
&nbsp;*<br />
&nbsp;* hybris is distributed in the hope that it will be useful,<br />
&nbsp;* but WITHOUT ANY WARRANTY; without even the implied warranty of<br />
&nbsp;* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. &nbsp;See the<br />
&nbsp;* GNU General Public License for more details.<br />
&nbsp;*<br />
&nbsp;* You should have received a copy of the GNU General Public License<br />
&nbsp;* along with hybris. &nbsp;If not, see &lt;http://www.gnu.org/licenses/&gt;.<br />
*/</span><br />
<br />
<span class="co1">// funzione di inizializzazione</span><br />
<span class="kw2">function</span> dbc_init<span class="br0">&#40;</span> <span class="re0">$dbhost</span><span class="sy0">,</span> <span class="re0">$dbuser</span><span class="sy0">,</span> <span class="re0">$dbpass</span><span class="sy0">,</span> <span class="re0">$dbname</span><span class="sy0">,</span> <span class="re0">$storage</span><span class="sy0">,</span> <span class="re0">$lifetime</span> <span class="sy0">=</span> <span class="nu0">1800</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="co1">// controllo che la directory di caching esista</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="sy0">!</span><span class="kw3">file_exists</span><span class="br0">&#40;</span><span class="re0">$storage</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">die</span><span class="br0">&#40;</span> <span class="st0">&quot;DBCACHE : Path '<span class="es4">$storage</span>' does not exist .&quot;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="co1">// controllo che sia scrivibile</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="sy0">!</span><span class="kw3">is_writable</span><span class="br0">&#40;</span><span class="re0">$storage</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">die</span><span class="br0">&#40;</span> <span class="st0">&quot;DBCACHE : Path '<span class="es4">$storage</span>' is not writable .&quot;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="co1">// apro una connessione persistente al db</span><br />
&nbsp; &nbsp; <span class="kw3">mysql_pconnect</span><span class="br0">&#40;</span> <span class="re0">$dbhost</span><span class="sy0">,</span> <span class="re0">$dbuser</span><span class="sy0">,</span> <span class="re0">$dbpass</span> <span class="br0">&#41;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; or <span class="kw3">die</span><span class="br0">&#40;</span> <span class="st0">&quot;DBCACHE : &quot;</span><span class="sy0">.</span><span class="kw3">mysql_error</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="co1">// seleziono il db</span><br />
&nbsp; &nbsp; <span class="kw3">mysql_select_db</span><span class="br0">&#40;</span> <span class="re0">$dbname</span> <span class="br0">&#41;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; or <span class="kw3">die</span><span class="br0">&#40;</span> <span class="st0">&quot;DBCACHE : &quot;</span><span class="sy0">.</span><span class="kw3">mysql_error</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; <span class="co1">// definisco le variabili che mi servono</span><br />
&nbsp; &nbsp; <span class="kw3">define</span><span class="br0">&#40;</span> <span class="st0">&quot;DBCACHE_STORAGE&quot;</span><span class="sy0">,</span> &nbsp;<span class="re0">$storage</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="kw3">define</span><span class="br0">&#40;</span> <span class="st0">&quot;DBCACHE_LIFETIME&quot;</span><span class="sy0">,</span> <span class="re0">$lifetime</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
<span class="br0">&#125;</span><br />
<br />
<span class="co1">// serializza i risultati di una query e li salva in cache</span><br />
<span class="kw2">function</span> dbc_cache<span class="br0">&#40;</span> <span class="re0">$hash</span><span class="sy0">,</span> <span class="re0">$resource</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="re0">$object</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="co1">// indice incrementale per il fetching</span><br />
&nbsp; &nbsp; <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> &nbsp; &nbsp; &nbsp;<span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="co1">// numero righe</span><br />
&nbsp; &nbsp; <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'num_rows'</span><span class="br0">&#93;</span> &nbsp; <span class="sy0">=</span> <span class="kw3">mysql_num_rows</span><span class="br0">&#40;</span><span class="re0">$resource</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="co1">// numero campi</span><br />
&nbsp; &nbsp; <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'num_fields'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">mysql_num_fields</span><span class="br0">&#40;</span><span class="re0">$resource</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="co1">// nome dei campi</span><br />
&nbsp; &nbsp; <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'fields'</span><span class="br0">&#93;</span> &nbsp; &nbsp; <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; &nbsp; <br />
&nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span> <span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'num_fields'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">++</span> <span class="br0">&#41;</span><span class="br0">&#123;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'fields'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw3">mysql_field_name</span><span class="br0">&#40;</span> <span class="re0">$resource</span><span class="sy0">,</span> <span class="re0">$i</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="co1">// recordset</span><br />
&nbsp; &nbsp; <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'rows'</span><span class="br0">&#93;</span> &nbsp; &nbsp; &nbsp; <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span> <span class="re0">$row</span> <span class="sy0">=</span> <span class="kw3">mysql_fetch_array</span><span class="br0">&#40;</span><span class="re0">$resource</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$object</span><span class="br0">&#91;</span><span class="st_h">'rows'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$row</span><span class="sy0">;</span> &nbsp; <br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="co1">// per sicurezza resetto il puntatore alla risorsa</span><br />
&nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">mysql_data_seek</span><span class="br0">&#40;</span> <span class="re0">$resource</span><span class="sy0">,</span> <span class="nu0">0</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="co1">// salvo l'oggetto nella cache</span><br />
&nbsp; &nbsp; <span class="kw1">return</span> dbc_save_cache<span class="br0">&#40;</span> <span class="re0">$hash</span><span class="sy0">,</span> <span class="re0">$object</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
<span class="br0">&#125;</span><br />
<span class="co1">// crea il file di cache per un oggetto</span><br />
<span class="kw2">function</span> dbc_save_cache<span class="br0">&#40;</span> <span class="re0">$hash</span><span class="sy0">,</span> <span class="sy0">&amp;</span><span class="re0">$obj</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="re0">$file</span> <span class="sy0">=</span> DBCACHE_STORAGE<span class="sy0">.</span><span class="st0">&quot;/&quot;</span><span class="sy0">.</span><span class="re0">$hash</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; <span class="re0">$f</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">fopen</span><span class="br0">&#40;</span> <span class="re0">$file</span><span class="sy0">,</span> <span class="st_h">'w'</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span> <span class="sy0">!</span><span class="re0">$f</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="co1">// imposto un lock esclusivo sul file e ci serializzo i contenuti</span><br />
&nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">flock</span><span class="br0">&#40;</span> <span class="re0">$f</span><span class="sy0">,</span> LOCK_EX <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">fwrite</span><span class="br0">&#40;</span> <span class="re0">$f</span><span class="sy0">,</span> <span class="kw3">serialize</span><span class="br0">&#40;</span> <span class="re0">$obj</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">flock</span><span class="br0">&#40;</span> <span class="re0">$f</span><span class="sy0">,</span> LOCK_UN <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">fclose</span><span class="br0">&#40;</span> <span class="re0">$f</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">chmod</span><span class="br0">&#40;</span> <span class="re0">$file</span><span class="sy0">,</span> <span class="nu8">0644</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <br />
&nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$obj</span><span class="sy0">;</span><br />
<span class="br0">&#125;</span><br />
<span class="co1">// rimuovo un dato oggetto dalla cache</span><br />
<span class="kw2">function</span> dbc_remove<span class="br0">&#40;</span> <span class="re0">$hash</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="re0">$file</span> <span class="sy0">=</span> DBCACHE_STORAGE<span class="sy0">.</span><span class="st0">&quot;/&quot;</span><span class="sy0">.</span><span class="re0">$hash</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="kw3">is_file</span><span class="br0">&#40;</span> <span class="re0">$file</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">unlink</span><span class="br0">&#40;</span> <span class="re0">$file</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
<span class="br0">&#125;</span><br />
<span class="co1">// cancello la cache, se $old è true elimino solo gli oggetti scaduti,</span><br />
<span class="co1">// altrimenti elminino tutto</span><br />
<span class="kw2">function</span> dbc_clean<span class="br0">&#40;</span> <span class="re0">$old</span> <span class="sy0">=</span> <span class="kw4">true</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span> <span class="re0">$dir</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">opendir</span><span class="br0">&#40;</span> DBCACHE_STORAGE <span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">while</span> <span class="br0">&#40;</span> <span class="re0">$hash</span> <span class="sy0">=</span> <span class="kw3">readdir</span><span class="br0">&#40;</span> <span class="re0">$dir</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span> <span class="re0">$hash</span> <span class="sy0">!=</span> <span class="st_h">'.'</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$hash</span> <span class="sy0">!=</span> <span class="st_h">'..'</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$hash</span> <span class="sy0">!=</span> <span class="st_h">'.htaccess'</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Clean all</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$old</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbc_remove<span class="br0">&#40;</span><span class="re0">$hash</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">elseif</span> <span class="br0">&#40;</span> <span class="br0">&#40;</span> <span class="sy0">@</span><span class="kw3">filemtime</span><span class="br0">&#40;</span> <span class="re0">$file</span> <span class="br0">&#41;</span> <span class="sy0">+</span> DBCACHE_LIFETIME <span class="sy0">-</span> <span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="sy0">&lt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Clean only old</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbc_remove<span class="br0">&#40;</span><span class="re0">$hash</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">closedir</span><span class="br0">&#40;</span> <span class="re0">$dir</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
<span class="br0">&#125;</span><br />
<span class="co1">// funzione per controllare se esiste un oggetto in cache</span><br />
<span class="kw2">function</span> dbc_is_cached<span class="br0">&#40;</span> <span class="re0">$hash</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw3">file_exists</span><span class="br0">&#40;</span> DBCACHE_STORAGE<span class="sy0">.</span><span class="st0">&quot;/&quot;</span><span class="sy0">.</span><span class="re0">$hash</span> <span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; &nbsp; <br />
<span class="br0">&#125;</span><br />
<span class="co1">// determina se una data query è inseribile in cache .</span><br />
<span class="co1">// solo le query in lettura sono cachabili .</span><br />
<span class="kw2">function</span> dbc_is_cachable<span class="br0">&#40;</span> <span class="re0">$query</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">return</span> <span class="sy0">!</span><span class="kw3">preg_match</span><span class="br0">&#40;</span> <span class="st0">&quot;/\s*(INSERT[\s]+|DELETE[\s]+|UPDATE[\s]+|REPLACE[\s]+|ALTER[\s]+|SET[\s]+|FOUND_ROWS[\s]+|SQL_NO_CACHE[\s]+)/si&quot;</span><span class="sy0">,</span> <span class="re0">$query</span> <span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; &nbsp; <br />
<span class="br0">&#125;</span><br />
<span class="co1">// determina se l'oggetto appartiene alla cache o è una risorsa</span><br />
<span class="kw2">function</span> dbc_is_cached_object<span class="br0">&#40;</span> <span class="sy0">&amp;</span><span class="re0">$object</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw3">is_array</span><span class="br0">&#40;</span><span class="re0">$object</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
<span class="br0">&#125;</span><br />
<span class="co1">// esegue una query e ne cacha i risultati, oppure preleva direttamente la cache</span><br />
<span class="co1">// nel caso sia già presente</span><br />
<span class="kw2">function</span> dbc_query<span class="br0">&#40;</span> <span class="re0">$query</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="co1">// calcolo l'hash della query</span><br />
&nbsp; &nbsp; <span class="re0">$hash</span> <span class="sy0">=</span> <span class="kw3">md5</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="co1">// è già in cache?</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cached<span class="br0">&#40;</span><span class="re0">$hash</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span> &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$file</span> &nbsp; <span class="sy0">=</span> DBCACHE_STORAGE<span class="sy0">.</span><span class="st0">&quot;/&quot;</span><span class="sy0">.</span><span class="re0">$hash</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$object</span> <span class="sy0">=</span> <span class="kw4">null</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span> <span class="re0">$filemtime</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">filemtime</span><span class="br0">&#40;</span> <span class="re0">$file</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// apro il file nella cache impostando un lock esclusivo</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$f</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">fopen</span><span class="br0">&#40;</span> <span class="re0">$file</span><span class="sy0">,</span> <span class="st_h">'r'</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span> <span class="re0">$f</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">flock</span><span class="br0">&#40;</span> <span class="re0">$f</span><span class="sy0">,</span> LOCK_SH <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// deserializzo l'oggetto</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$object</span> <span class="sy0">=</span> <span class="kw3">unserialize</span><span class="br0">&#40;</span> <span class="kw3">stream_get_contents</span><span class="br0">&#40;</span> <span class="re0">$f</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">flock</span><span class="br0">&#40;</span> <span class="re0">$f</span><span class="sy0">,</span> LOCK_UN <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">@</span><span class="kw3">fclose</span><span class="br0">&#40;</span> <span class="re0">$f</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// se l'oggetto è scaduto lo rimuovo dalla cache</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span> <span class="br0">&#40;</span> <span class="re0">$filemtime</span> <span class="sy0">+</span> DBCACHE_LIFETIME <span class="sy0">-</span> <span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="sy0">&lt;</span> <span class="nu0">0</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbc_remove<span class="br0">&#40;</span> <span class="re0">$hash</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$object</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="co1">// non è nella cache</span><br />
&nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// eseguo la query vera e propria</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$resource</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">mysql_query</span><span class="br0">&#40;</span> <span class="re0">$query</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// se la query è cachabile la inserisco nello storage</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cachable<span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span><span class="re0">$object</span> <span class="sy0">=</span> dbc_cache<span class="br0">&#40;</span> <span class="re0">$hash</span><span class="sy0">,</span> <span class="re0">$resource</span> <span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$object</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// la query non è cachabile, elimino tutta la cache poichè la query appena</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// eseguita ha inserito e/o aggiornato i dati sul db</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbc_clean<span class="br0">&#40;</span> <span class="kw4">false</span> <span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$resource</span><span class="sy0">;</span> &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
<span class="br0">&#125;</span> <br />
<span class="co1">// fetching associativo</span><br />
<span class="kw2">function</span> dbc_fetch_assoc<span class="br0">&#40;</span> <span class="sy0">&amp;</span><span class="re0">$obj</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cached_object<span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="kw4">false</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="sy0">@</span><span class="kw3">mysql_fetch_assoc</span><span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> <span class="sy0">&gt;=</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'num_rows'</span><span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span> &nbsp; <br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span> <span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'num_fields'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">++</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span><span class="br0">&#91;</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'fields'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span> <span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'rows'</span><span class="br0">&#93;</span><span class="br0">&#91;</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> <span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="sy0">;</span> &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span><span class="sy0">++;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$row</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
<span class="br0">&#125;</span><br />
<span class="co1">// fetching vettoriale</span><br />
<span class="kw2">function</span> dbc_fetch_row<span class="br0">&#40;</span> <span class="sy0">&amp;</span><span class="re0">$obj</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cached_object<span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="kw4">false</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="sy0">@</span><span class="kw3">mysql_fetch_row</span><span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> <span class="sy0">&gt;=</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'num_rows'</span><span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span> &nbsp; <br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span><span class="br0">&#40;</span> <span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'num_fields'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">++</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$row</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'rows'</span><span class="br0">&#93;</span><span class="br0">&#91;</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> <span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$i</span><span class="br0">&#93;</span><span class="sy0">;</span> &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span><span class="sy0">++;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$row</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span> &nbsp; <br />
<span class="br0">&#125;</span><br />
<span class="co1">// rimuove l'oggetto dalla memoria</span><br />
<span class="kw2">function</span> dbc_free_result<span class="br0">&#40;</span> <span class="sy0">&amp;</span><span class="re0">$obj</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cached_object<span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="kw4">false</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="sy0">@</span><span class="kw3">mysql_free_result</span><span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw3">unset</span><span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span><span class="sy0">;</span>&nbsp; &nbsp; <br />
<span class="br0">&#125;</span><br />
<span class="co1">// restituisce il numero di recordset nell'oggetto</span><br />
<span class="kw2">function</span> dbc_num_rows<span class="br0">&#40;</span> <span class="sy0">&amp;</span><span class="re0">$obj</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cached_object<span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="kw4">false</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="sy0">@</span><span class="kw3">mysql_num_rows</span><span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'num_rows'</span><span class="br0">&#93;</span><span class="sy0">;</span>&nbsp; &nbsp; <br />
<span class="br0">&#125;</span><br />
<span class="co1">// imposta il cursore sull'oggetto</span><br />
<span class="kw2">function</span> dbc_data_seek<span class="br0">&#40;</span> <span class="sy0">&amp;</span><span class="re0">$obj</span><span class="sy0">,</span> <span class="re0">$idx</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cached_object<span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="kw4">false</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="sy0">@</span><span class="kw3">mysql_data_seek</span><span class="br0">&#40;</span><span class="re0">$obj</span><span class="sy0">,</span><span class="re0">$idx</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> <span class="re0">$idx</span> <span class="sy0">&gt;=</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'num_rows'</span><span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span> &nbsp; <br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">else</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'index'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$idx</span><span class="sy0">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span>&nbsp; &nbsp; <br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
<span class="br0">&#125;</span><br />
<span class="co1">// restituisce il numero di campi nell'oggetto</span><br />
<span class="kw2">function</span> dbc_num_fields<span class="br0">&#40;</span> <span class="sy0">&amp;</span><span class="re0">$obj</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> dbc_is_cached_object<span class="br0">&#40;</span><span class="re0">$obj</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="kw4">false</span> <span class="br0">&#41;</span><span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="sy0">@</span><span class="kw3">mysql_num_fields</span><span class="br0">&#40;</span><span class="re0">$obj</span><span class="sy0">,</span><span class="re0">$idx</span><span class="br0">&#41;</span><span class="sy0">;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">return</span> <span class="re0">$obj</span><span class="br0">&#91;</span><span class="st_h">'num_fields'</span><span class="br0">&#93;</span><span class="sy0">;</span>&nbsp; <br />
<span class="br0">&#125;</span><br />
&nbsp; &nbsp; <br />
<span class="sy1">?&gt;</span></div></div>

